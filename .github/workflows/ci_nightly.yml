name: Nightly Build

on:
  workflow_dispatch:

jobs:
  build:
    name: Build and Sign

    runs-on: macos-11.0

    steps:
      - name: Checkout Hammerspoon Code
        uses: actions/checkout@v2
      - name: Checkout Hammerspoon Secrets
        uses: actions/checkout@v2
        with:
          repository: Hammerspoon/ci-secrets
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ../ci-secrets
      - name: Decrypt Secrets
        env:
          REPO_GPG_PASSPHRASE: ${{ secrets.REPO_GPG_PASSPHRASE }}
        cmd: ../ci-secrets/crypto.sh decrypt
      - name: Import signing key
        cmd: /usr/bin/security import ../ci-secrets/Cleartext/Hammerspoon_Nightly-developerID_application.cer
      - name: Prepare secure tokens
        cmd: /bin/cp ../ci-secrets/Cleartext/token* ../
      - name: Prepare build environment
        cmd: ./scripts/github-ci-pre.sh
      - name: Get version number
        run: |
          echo ::set-env name=NIGHTLY_VERSION::$(git-describe)
      - name: Build
        cmd: ./scripts/release.sh --nightly
      - name: Upload artifacts
          uses: actions/upload-artifact@v2
          with:
            path: |
              ../archive/${{ env.NIGHTLY_VERSION }}/Hammerspoon-${{ env.NIGHTLY_VERSION }}.zip
              ../archive/${{ env.NIGHTLY_VERSION }}/Hammerspoon-dSYM-${{ env.NIGHTLY_VERSION }}.zip
              ../archive/${{ env.NIGHTLY_VERSION }}/Hammerspoon-docs-${{ env.NIGHTLY_VERSION }}.zip
              ../archive/${{ env.NIGHTLY_VERSION }}/dSYM_UUID.txt
              ../archive/${{ env.NIGHTLY_VERSION }}/release-build.log
              ../archive/${{ env.NIGHTLY_VERSION }}/notarization-upload.log
      - name: IRC notification
        uses: Gottox/irc-message-action@v1.3.0
        with:
          channel: '#hammerspoon'
          nickname: 'HS_CI_Nightly'
          message: |
            New nightly build: ${{ env.NIGHTLY_VERSION }}
